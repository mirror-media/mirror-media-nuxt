steps:
  - name: bash
    args:
      - rm
      - "-rf"
      - ../configs
  - name: bash
    args:
      - rm
      - "-rf"
      - ./configs/*
  - name: gcr.io/cloud-builders/gcloud
    args:
      - source
      - repos
      - clone
      - configs
      - configs.build
  - name: bash
    args:
      - cp
      - "-R"
      - ./configs.build/mirror-media/mirror-media-nuxt/gcskeyfile.json
      - ./gcskeyfile.json
  - name: bash
    args:
      - cp
      - "-R"
      - ./configs.build/mirror-media/mirror-media-nuxt/dev/config.js
      - ./configs/config.js
  - name: bash
    args:
      - rm
      - "-R"
      - ./configs.build
  - name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - "-c"
      # - "docker pull gcr.io/${PROJECT_ID}/mirror-media-nuxt:${BRANCH_NAME} || exit 0"
      - "docker pull gcr.io/${PROJECT_ID}/mirror-media-nuxt:ci || exit 0"
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - "-t"
      - "gcr.io/${PROJECT_ID}/mirror-media-nuxt"
      - "-t"
      - "gcr.io/$PROJECT_ID/mirror-media-nuxt:ci_${SHORT_SHA}_${BUILD_ID}"
      - "--cache-from"
      # - "gcr.io/$PROJECT_ID/mirror-media-nuxt:${BRANCH_NAME}"
      - "gcr.io/$PROJECT_ID/mirror-media-nuxt:ci"
      - .
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - gcr.io/$PROJECT_ID/mirror-media-nuxt

timeout: 1800s
